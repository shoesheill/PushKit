name: Publish Pushkit to NuGet

on:
  push:
    tags:
      - 'v[0-9]+.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -------------------------
    # Extract Version (Handles both Tag and Manual Input)
    # -------------------------
    - name: Extract version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # Use manual input from the UI
          VERSION="${{ github.event.inputs.version }}"
        else
          # Extract from tag (strips 'refs/tags/' and 'v')
          RAW_TAG=${GITHUB_REF#refs/tags/}
          VERSION=${RAW_TAG#v}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Processing version: $VERSION"

    # -------------------------
    # Setup .NET
    # -------------------------
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "10.0.x"

    # -------------------------
    # Restore, Build & Pack
    # -------------------------
    - name: Restore dependencies
      run: dotnet restore src/PushKit.Core/PushKit.Core.csproj

    - name: Build
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        dotnet build src/PushKit.Core/PushKit.Core.csproj \
          --configuration Release \
          --no-restore \
          /p:Version=$VERSION

    - name: Pack
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        dotnet pack src/PushKit.Core/PushKit.Core.csproj \
          --configuration Release \
          --output ./nupkg \
          --no-build \
          /p:PackageVersion=$VERSION \
          /p:Version=$VERSION

    # -------------------------
    # Publish to NuGet
    # -------------------------
    - name: Publish to NuGet
      run: |
        # Use Case-Sensitive filename: PushKit.Core
        dotnet nuget push ./nupkg/PushKit.Core.*.nupkg \
          --api-key "${{ secrets.NUGET_API_KEY }}" \
          --source "https://api.nuget.org/v3/index.json" \
          --skip-duplicate
